const fs = require('fs');
const path = require('path');

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª—ë—Ç—á–∏–∫–æ–≤
const activePilots = new Map(); // userId -> { peerId, startTime, currentFlight, flightStage }

// –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª—ë—Ç—á–∏–∫–æ–≤
const PILOTS_FILE = path.join(__dirname, 'data', 'active_pilots.json');

// –¢–∏–ø—ã —Å–∞–º–æ–ª—ë—Ç–æ–≤
const AIRCRAFT_TYPES = [
  { id: 'boeing737', name: 'üõ© Boeing 737-800', passengers: 189, range: '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–µ–π—Å—ã', fuel: 26020, ceiling: 12500 },
  { id: 'airbus320', name: 'üõ© Airbus A320neo', passengers: 180, range: '–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ —Ä–µ–π—Å—ã', fuel: 24210, ceiling: 12000 },
  { id: 'boeing777', name: '‚úà Boeing 777-300ER', passengers: 396, range: '–î–∞–ª—å–Ω–µ–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–µ', fuel: 181280, ceiling: 13100 },
  { id: 'airbus380', name: '‚úà Airbus A380-800', passengers: 525, range: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ', fuel: 320000, ceiling: 13100 },
  { id: 'boeing787', name: '‚úà Boeing 787-9', passengers: 290, range: '–î–∞–ª—å–Ω–∏–µ —Ä–µ–π—Å—ã', fuel: 126372, ceiling: 13100 },
  { id: 'embraer190', name: 'üõ© Embraer E190', passengers: 114, range: '–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ', fuel: 13100, ceiling: 12500 }
];

// –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—ë—Ç–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞–º–∏
const DESTINATIONS = [
  { airport: 'SVO', city: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è', duration: 95, difficulty: 'easy', distance: 635 },
  { airport: 'LED', city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', country: '–†–æ—Å—Å–∏—è', duration: 85, difficulty: 'easy', distance: 635 },
  { airport: 'AER', city: '–°–æ—á–∏', country: '–†–æ—Å—Å–∏—è', duration: 140, difficulty: 'medium', distance: 1354 },
  { airport: 'SVX', city: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', country: '–†–æ—Å—Å–∏—è', duration: 165, difficulty: 'medium', distance: 1416 },
  { airport: 'CDG', city: '–ü–∞—Ä–∏–∂', country: '–§—Ä–∞–Ω—Ü–∏—è', duration: 215, difficulty: 'hard', distance: 2486 },
  { airport: 'LHR', city: '–õ–æ–Ω–¥–æ–Ω', country: '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', duration: 205, difficulty: 'hard', distance: 2510 },
  { airport: 'JFK', city: '–ù—å—é-–ô–æ—Ä–∫', country: '–°–®–ê', duration: 565, difficulty: 'extreme', distance: 7509 },
  { airport: 'NRT', city: '–¢–æ–∫–∏–æ', country: '–Ø–ø–æ–Ω–∏—è', duration: 585, difficulty: 'extreme', distance: 7816 },
  { airport: 'DXB', city: '–î—É–±–∞–π', country: '–û–ê–≠', duration: 285, difficulty: 'hard', distance: 2494 },
  { airport: 'IST', city: '–°—Ç–∞–º–±—É–ª', country: '–¢—É—Ä—Ü–∏—è', duration: 175, difficulty: 'medium', distance: 1773 }
];

// –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–ª—ë—Ç–æ–≤ —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–µ–π
const FLIGHT_STORIES = [
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—ë—Ç—ã (15 –∏—Å—Ç–æ—Ä–∏–π)
  {
    type: 'success',
    title: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–π—Å',
    events: [
      '–ü—Ä–µ–¥–ø–æ–ª—ë—Ç–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –≤ –Ω–æ—Ä–º–µ',
      '–ü–æ–ª—É—á–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∑–∞–ø—É—Å–∫ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π –æ—Ç –Ω–∞–∑–µ–º–Ω–æ–π —Å–ª—É–∂–±—ã',
      '–†—É–ª–µ–Ω–∏–µ –∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º—É —Å—Ç–∞—Ä—Ç—É –ø–æ —Ä—É–ª—ë–∂–Ω–æ–π –¥–æ—Ä–æ–∂–∫–µ Alpha',
      '–í–∑–ª—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —Å –ø–æ–ª–æ—Å—ã 07R. –ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã —ç—à–µ–ª–æ–Ω FL350',
      '–ü–æ–ª—ë—Ç –ø–æ –º–∞—Ä—à—Ä—É—Ç—É –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ. –ü–æ–≥–æ–¥–∞ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–∞—è',
      '–°–Ω–∏–∂–µ–Ω–∏–µ –∫ –∞—ç—Ä–æ–ø–æ—Ä—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è. –ó–∞—Ö–æ–¥ –Ω–∞ –ø–æ—Å–∞–¥–∫—É ILS 25L',
      '–ü–æ—Å–∞–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ. –†—É–ª–µ–Ω–∏–µ –∫ —Ç–µ–ª–µ—Ç—Ä–∞–ø—É'
    ],
    bonus: 1.0
  },
  {
    type: 'success',
    title: '–ü–æ–ª—ë—Ç —Å –ø–æ–ø—É—Ç–Ω—ã–º –≤–µ—Ç—Ä–æ–º',
    events: [
      '–ú–µ—Ç–µ–æ—Å–ª—É–∂–±–∞ —Å–æ–æ–±—â–∞–µ—Ç –æ —Å–∏–ª—å–Ω–æ–º –ø–æ–ø—É—Ç–Ω–æ–º –≤–µ—Ç—Ä–µ 80 —É–∑–ª–æ–≤',
      '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–ª–∞–Ω –ø–æ–ª—ë—Ç–∞. –†–∞—Å—á—ë—Ç–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞ —Å–æ–∫—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ 35 –º–∏–Ω—É—Ç',
      '–ü–æ–ª—ë—Ç –Ω–∞ —ç—à–µ–ª–æ–Ω–µ FL390. –ü—É—Ç–µ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å 920 –∫–º/—á',
      '–î–∏—Å–ø–µ—Ç—á–µ—Ä —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø—Ä—è–º–æ–π –∑–∞—Ö–æ–¥ –Ω–∞ –ø–æ—Å–∞–¥–∫—É',
      '–ü—Ä–∏–±—ã—Ç–∏–µ –Ω–∞ 25 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è'
    ],
    bonus: 1.1
  },
  {
    type: 'success',
    title: '–ù–æ—á–Ω–æ–π –ø–æ–ª—ë—Ç',
    events: [
      '–í—ã–ø–æ–ª–Ω—è–µ–º –Ω–æ—á–Ω–æ–π —Ä–µ–π—Å. –í–∏–¥–∏–º–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞',
      '–ü–æ–ª—ë—Ç –ø–æ –ø—Ä–∏–±–æ—Ä–∞–º IFR. –ê–≤—Ç–æ–ø–∏–ª–æ—Ç –≤–∫–ª—é—á—ë–Ω',
      '–°–≤—è–∑—å —Å —Ü–µ–Ω—Ç—Ä–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—ë—Ç–∞–º–∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è',
      '–ó–∞—Ö–æ–¥ –Ω–∞ –ø–æ—Å–∞–¥–∫—É –ø–æ —Å–∏—Å—Ç–µ–º–µ ILS CAT II',
      '–£—Å–ø–µ—à–Ω–∞—è –ø–æ—Å–∞–¥–∫–∞ –≤ —É—Å–ª–æ–≤–∏—è—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏'
    ],
    bonus: 1.2
  },
  {
    type: 'success',
    title: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ä–µ–π—Å',
    events: [
      '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü—ã',
      '–ü–æ–ª—ë—Ç —á–µ—Ä–µ–∑ –≤–æ–∑–¥—É—à–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Ç—Ä—ë—Ö —Å—Ç—Ä–∞–Ω',
      '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Å –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º–∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—Å–∫–∏–º–∏ —Å–ª—É–∂–±–∞–º–∏',
      '–°–º–µ–Ω–∞ —Ä–∞–¥–∏–æ—á–∞—Å—Ç–æ—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–∏ –≥—Ä–∞–Ω–∏—Ü',
      '–ü—Ä–∏–±—ã—Ç–∏–µ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –∞—ç—Ä–æ–ø–æ—Ä—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'
    ],
    bonus: 1.3
  },
  {
    type: 'success',
    title: '–ü–æ–ª—ë—Ç —Å –¥–æ–∑–∞–ø—Ä–∞–≤–∫–æ–π',
    events: [
      '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ—Å–∞–¥–∫–∞ –¥–ª—è –¥–æ–∑–∞–ø—Ä–∞–≤–∫–∏ —Ç–æ–ø–ª–∏–≤–æ–º',
      '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ–∑–¥—É—à–Ω–æ–≥–æ —Å—É–¥–Ω–∞',
      '–î–æ–∑–∞–ø—Ä–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–ª—É—á–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≤—ã–ª–µ—Ç',
      '–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–ª—ë—Ç–∞ –∫ –∫–æ–Ω–µ—á–Ω–æ–º—É –ø—É–Ω–∫—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è',
      '–û–±—â–µ–µ –≤—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å –Ω–∞ 90 –º–∏–Ω—É—Ç'
    ],
    bonus: 1.1
  },

  // –°–ª–æ–∂–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ (15 –∏—Å—Ç–æ—Ä–∏–π)
  {
    type: 'challenge',
    title: '–ó–æ–Ω–∞ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏',
    events: [
      '–ú–µ—Ç–µ–æ—Ä–∞–¥–∞—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–æ–Ω—É —Å–∏–ª—å–Ω–æ–π —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –≤–ø–µ—Ä–µ–¥–∏',
      '–í–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª "–ü—Ä–∏—Å—Ç–µ–≥–Ω–∏—Ç–µ —Ä–µ–º–Ω–∏". –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤',
      '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —ç—à–µ–ª–æ–Ω–∞ –ø–æ–ª—ë—Ç–∞',
      '–ü–æ–ª—É—á–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –Ω–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã –¥–æ FL370',
      '–¢—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–π–¥–µ–Ω–∞. –ü–æ–ª—ë—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ'
    ],
    bonus: 1.2
  },
  {
    type: 'challenge',
    title: '–ù–µ–ø–æ–≥–æ–¥–∞ –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è',
    events: [
      '–ú–µ—Ç–µ–æ—Å–ª—É–∂–±–∞ —Å–æ–æ–±—â–∞–µ—Ç: –≤–∏–¥–∏–º–æ—Å—Ç—å 800–º, –æ—Å–∞–¥–∫–∏, –≤–µ—Ç–µ—Ä 15 –º/—Å',
      '–î–∏—Å–ø–µ—Ç—á–µ—Ä –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–π—Ç–∏ –Ω–∞ –∫—Ä—É–≥ –æ–∂–∏–¥–∞–Ω–∏—è',
      '–í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—ë—Ç –ø–æ –∫—Ä—É–≥—É –Ω–∞ —ç—à–µ–ª–æ–Ω–µ FL80',
      '–ü–æ–ª—É—á–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∑–∞—Ö–æ–¥ –Ω–∞ –ø–æ—Å–∞–¥–∫—É',
      '–ü–æ—Å–∞–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —Å–ª–æ–∂–Ω—ã—Ö –º–µ—Ç–µ–æ—É—Å–ª–æ–≤–∏—è—Ö'
    ],
    bonus: 1.3
  },
  {
    type: 'challenge',
    title: '–û—Ç–∫–∞–∑ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞',
    events: [
      '–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç: –æ—Ç–∫–∞–∑ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –ø–æ –∫–∞–Ω–∞–ª—É –∫—Ä–µ–Ω–∞',
      '–ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–¥—É—à–Ω—ã–º —Å—É–¥–Ω–æ–º',
      '–£–≤–µ–¥–æ–º–ª—è–µ–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏',
      '–ü–æ–ª—ë—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ',
      '–ü–æ—Å–∞–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ'
    ],
    bonus: 1.4
  },
  {
    type: 'challenge',
    title: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ—Å–∞–¥–∫–∞',
    events: [
      '–ù–∞ –±–æ—Ä—Ç—É –ø–∞—Å—Å–∞–∂–∏—Ä —Å —Å–µ—Ä–¥–µ—á–Ω—ã–º –ø—Ä–∏—Å—Ç—É–ø–æ–º',
      '–ë–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—É—é –º–µ–¥–ø–æ–º–æ—â—å',
      '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—É—é –ø–æ—Å–∞–¥–∫—É –≤ –±–ª–∏–∂–∞–π—à–µ–º –∞—ç—Ä–æ–ø–æ—Ä—Ç—É',
      '–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø–æ—Å–∞–¥–∫—É',
      '–ü–∞—Å—Å–∞–∂–∏—Ä –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –±–æ–ª—å–Ω–∏—Ü—É —Å–∫–æ—Ä–æ–π –ø–æ–º–æ—â—å—é'
    ],
    bonus: 1.3
  },
  {
    type: 'challenge',
    title: '–ó–∞–∫—Ä—ã—Ç–∏–µ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞',
    events: [
      '–ê—ç—Ä–æ–ø–æ—Ä—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç',
      '–ü—Ä–∏–Ω–∏–º–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ –ª–µ—Ç–µ—Ç—å –≤ –∑–∞–ø–∞—Å–Ω–æ–π –∞—ç—Ä–æ–ø–æ—Ä—Ç',
      '–ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞',
      '–£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–∑–µ–º–ª—è–µ–º—Å—è –≤ –∑–∞–ø–∞—Å–Ω–æ–º –∞—ç—Ä–æ–ø–æ—Ä—Ç—É',
      '–ü–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –∞–≤—Ç–æ–±—É—Å–∞–º–∏ –¥–æ –º–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'
    ],
    bonus: 1.1
  },

  // –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ (5 –∏—Å—Ç–æ—Ä–∏–π)
  {
    type: 'extreme',
    title: '–ê–≤–∞—Ä–∏–π–Ω–∞—è –ø–æ—Å–∞–¥–∫–∞',
    events: [
      '‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—è!',
      '–û–±—ä—è–≤–ª—è–µ–º —á—Ä–µ–∑–≤—ã—á–∞–π–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é',
      '–ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –∞–≤–∞—Ä–∏–π–Ω–æ–π –ø–æ—Å–∞–¥–∫–µ',
      '–°—Ç—é–∞—Ä–¥–µ—Å—Å–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∏—Ä—É–µ—Ç –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤',
      '–ú–∞—Å—Ç–µ—Ä—Å–∫–∏ —Å–æ–≤–µ—Ä—à–∞–µ—Ç–µ –∞–≤–∞—Ä–∏–π–Ω—É—é –ø–æ—Å–∞–¥–∫—É',
      'üéâ –í—Å–µ –ø–∞—Å—Å–∞–∂–∏—Ä—ã –∏ —ç–∫–∏–ø–∞–∂ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!',
      'üèÜ –í—ã –≥–µ—Ä–æ–π! –ü–æ–ª—É—á–∞–µ—Ç–µ –Ω–∞–≥—Ä–∞–¥—É –∑–∞ –º—É–∂–µ—Å—Ç–≤–æ'
    ],
    bonus: 2.0
  },
  {
    type: 'extreme',
    title: '–£–≥–æ–Ω —Å–∞–º–æ–ª—ë—Ç–∞',
    events: [
      'üò± –ü–æ–ø—ã—Ç–∫–∞ —É–≥–æ–Ω–∞ —Å–∞–º–æ–ª—ë—Ç–∞!',
      '–°–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ —Å–ª–µ–¥—É–µ—Ç–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—É',
      '–ù–µ–∑–∞–º–µ—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç–µ —Å–∏–≥–Ω–∞–ª –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É',
      '–°–ª—É–∂–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≥–æ—Ç–æ–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—è–º',
      '–£–≥–æ–Ω—â–∏–∫ –æ–±–µ–∑–≤—Ä–µ–∂–µ–Ω —Å–ª—É–∂–±–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
      'üëÆ –ü–æ–ª–∏—Ü–∏—è –∞—Ä–µ—Å—Ç–æ–≤—ã–≤–∞–µ—Ç –ø—Ä–µ—Å—Ç—É–ø–Ω–∏–∫–∞',
      'üèÖ –ü–æ–ª—É—á–∞–µ—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –æ—Ç –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞'
    ],
    bonus: 3.0
  }
];

// –ó–∞–≥—Ä—É–∑–∫–∞ –ª—ë—Ç—á–∏–∫–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
function loadPilots() {
  try {
    if (fs.existsSync(PILOTS_FILE)) {
      const data = JSON.parse(fs.readFileSync(PILOTS_FILE, 'utf8'));
      for (const [userId, pilotData] of Object.entries(data)) {
        activePilots.set(parseInt(userId), {
          ...pilotData,
          startTime: new Date(pilotData.startTime)
        });
      }
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª—ë—Ç—á–∏–∫–æ–≤:', error);
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª—ë—Ç—á–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª
function savePilots() {
  try {
    const dataDir = path.dirname(PILOTS_FILE);
    if (!fs.existsSync(dataDir)) {
      fs.mkdirSync(dataDir, { recursive: true });
    }
    
    const data = {};
    for (const [userId, pilotData] of activePilots.entries()) {
      data[userId] = {
        peerId: pilotData.peerId,
        startTime: pilotData.startTime.toISOString(),
        currentFlight: pilotData.currentFlight,
        flightStage: pilotData.flightStage
      };
    }
    
    fs.writeFileSync(PILOTS_FILE, JSON.stringify(data, null, 2));
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ª—ë—Ç—á–∏–∫–æ–≤:', error);
  }
}

// –£—Å—Ç—Ä–æ–∏—Ç—å –ª—ë—Ç—á–∏–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç—É
function hirePilot(userId, peerId) {
  if (activePilots.has(userId)) {
    return false; // –£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
  }
  
  const pilot = {
    peerId: peerId,
    startTime: new Date(),
    currentFlight: null,
    flightStage: 'idle'
  };
  
  activePilots.set(userId, pilot);
  savePilots();
  return true;
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –ª—ë—Ç—á–∏–∫
function isPilot(userId) {
  return activePilots.has(userId);
}

// –ù–∞—á–∞—Ç—å –ø–æ–ª—ë—Ç
function startFlight(userId, aircraftType, destination) {
  if (!activePilots.has(userId)) {
    return null;
  }
  
  const pilot = activePilots.get(userId);
  const aircraft = AIRCRAFT_TYPES.find(a => a.id === aircraftType);
  const dest = DESTINATIONS.find(d => d.city === destination) || DESTINATIONS[Math.floor(Math.random() * DESTINATIONS.length)];
  const story = FLIGHT_STORIES[Math.floor(Math.random() * FLIGHT_STORIES.length)];
  
  const flight = {
    id: Date.now(),
    aircraft: aircraft,
    destination: dest,
    story: story,
    startTime: new Date(),
    stage: 'boarding',
    stageIndex: 0
  };
  
  pilot.currentFlight = flight;
  pilot.flightStage = 'flying';
  savePilots();
  
  return flight;
}

// –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—ë—Ç–µ
function getCurrentFlight(userId) {
  if (!activePilots.has(userId)) {
    return null;
  }
  
  const pilot = activePilots.get(userId);
  return pilot.currentFlight;
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–ª—ë—Ç
function completeFlight(userId) {
  if (!activePilots.has(userId)) {
    return null;
  }
  
  const pilot = activePilots.get(userId);
  const flight = pilot.currentFlight;
  
  if (!flight) {
    return null;
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É
  const baseSalary = 50000;
  const bonus = flight.story.bonus || 1.0;
  const salary = Math.floor(baseSalary * bonus);
  
  // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ–ª—ë—Ç
  pilot.currentFlight = null;
  pilot.flightStage = 'idle';
  savePilots();
  
  return {
    flight: flight,
    salary: salary
  };
}

// –£–≤–æ–ª–∏—Ç—å –ª—ë—Ç—á–∏–∫–∞
function firePilot(userId) {
  if (activePilots.has(userId)) {
    activePilots.delete(userId);
    savePilots();
    return true;
  }
  return false;
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–∞–º–æ–ª—ë—Ç–æ–≤
function getAircraftTypes() {
  return AIRCRAFT_TYPES;
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
function getRandomDestination() {
  return DESTINATIONS[Math.floor(Math.random() * DESTINATIONS.length)];
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ª—ë—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è
loadPilots();

module.exports = {
  hirePilot,
  isPilot,
  startFlight,
  getCurrentFlight,
  completeFlight,
  firePilot,
  getAircraftTypes,
  getRandomDestination,
  FLIGHT_STORIES
};
